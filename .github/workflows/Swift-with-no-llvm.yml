name: "Swift-with-no-llvm ‚Äî v22.0 Full Transpiler + Executable + ProofLedger"

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: swift-no-llvm-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      # -----------------------------------------
      # 0) Checkout
      # -----------------------------------------
      - name: Checkout
        uses: actions/checkout@v4

      # -----------------------------------------
      # 1) Install Tools
      # -----------------------------------------

      - name: Install Build Tools (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update -y
          sudo apt-get install -y clang g++ nasm zip

      - name: Install Build Tools (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install llvm nasm zip || true
          echo 'export PATH="/usr/local/opt/llvm/bin:/opt/homebrew/opt/llvm/bin:$PATH"' >> ~/.bash_profile
          source ~/.bash_profile || true

      - name: Install Build Tools (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          choco install llvm -y
          choco install zip -y
          "C:\Program Files\LLVM\bin" | Out-File -FilePath $env:GITHUB_PATH -Append

      # -----------------------------------------
      # 2) Compile Swift Transpiler (C++)
      # -----------------------------------------
      - name: Build Transpiler
        shell: bash
        run: |
          mkdir -p build dist

          echo "Building transpiler with all cpp sources..."

          if [ "$RUNNER_OS" = "Windows" ]; then
            clang++ -std=c++17 \
              src/main.cpp \
              src/parser.cpp \
              src/ast.cpp \
              src/codegen.cpp \
              src/evaluator.cpp \
              -o build/swift_transpiler.exe
          else
            clang++ -std=c++17 \
              src/main.cpp \
              src/parser.cpp \
              src/ast.cpp \
              src/codegen.cpp \
              src/evaluator.cpp \
              -o build/swift_transpiler
          fi

      # -----------------------------------------
      # 3) Run Swift ‚Üí C++ (generate out.cpp)
      # -----------------------------------------
      - name: Run Transpiler
        shell: bash
        run: |
          echo "Running Swift ‚Üí C++ transpiler..."

          if [ "$RUNNER_OS" = "Windows" ]; then
            ./build/swift_transpiler.exe || true
          else
            ./build/swift_transpiler || true
          fi

          ls -R .

      # -----------------------------------------
      # 4) Patch out.cpp if malformed
      # -----------------------------------------
      - name: Patch C++ Output
        shell: bash
        run: |
          if [ ! -f out.cpp ]; then
            echo "‚ùå out.cpp not generated. Parser incomplete."
            exit 1
          fi

          if ! grep -q "int main" out.cpp; then
            echo "‚öôÔ∏è Wrapping with main()"
            sed -i '1i #include <iostream>\nusing namespace std;\nint main(){' out.cpp || true
            echo "}" >> out.cpp
          fi

      # -----------------------------------------
      # 5) Generate ASM
      # -----------------------------------------
      - name: Generate ASM
        shell: bash
        run: |
          echo "Generating ASM..."
          if [ "$RUNNER_OS" = "Windows" ]; then
            clang++ -S -masm=intel out.cpp -o out.asm
          else
            clang++ -S -masm=intel out.cpp -o out.asm
          fi

      # -----------------------------------------
      # 6) Build Executable from out.cpp
      # -----------------------------------------
      - name: Build Executable
        shell: bash
        run: |
          mkdir -p dist

          echo "Building executable from out.cpp..."

          if [ "$RUNNER_OS" = "Windows" ]; then
            clang++ out.cpp -o dist/out.exe
          else
            clang++ out.cpp -o dist/out
          fi

      # -----------------------------------------
      # 7) ProofLedger
      # -----------------------------------------
      - name: Generate ProofLedger
        shell: bash
        run: |
          echo "üßæ Generating ProofLedger..."

          HASH="sha256sum"
          if ! command -v sha256sum >/dev/null 2>&1; then
            HASH="shasum -a 256"
          fi

          mkdir -p dist

          $HASH out.cpp > dist/PROOF_LEDGER.txt
          $HASH out.asm >> dist/PROOF_LEDGER.txt
          $HASH dist/out* >> dist/PROOF_LEDGER.txt || true

      # -----------------------------------------
      # 8) Package
      # -----------------------------------------
      - name: Package Artifacts
        shell: bash
        run: |
          if [ "$RUNNER_OS" = "Windows" ]; then
            powershell -command "Compress-Archive -Path dist -DestinationPath swift-no-llvm-windows.zip"
          else
            zip -r swift-no-llvm-${{ matrix.os }}.zip dist
          fi

      # -----------------------------------------
      # 9) Tag
      # -----------------------------------------
      - name: Auto Tag
        id: tag
        shell: bash
        run: |
          VER="v$(date +%Y%m%d%H%M%S)"
          echo "version=$VER" >> $GITHUB_OUTPUT
          git config user.email "actions@github.com"
          git config user.name "github-actions"
          git tag -a "$VER" -m "Swift-with-no-llvm Release $VER"
          git push origin "$VER"

      # -----------------------------------------
      # üîü Release
      # -----------------------------------------
      - name: Publish Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.version }}
          files: |
            dist/**/*.txt
            dist/out*
            *.zip
          body: |
            Swift-with-no-LLVM v22.0
            - Swift ‚Üí C++ Transpiler
            - C++ ‚Üí ASM
            - Executable Build
            - ProofLedger Included

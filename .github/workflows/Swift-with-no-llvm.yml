name: "Swift-with-no-llvm ‚Äî v22.1 Ultra-Stable (Swift‚ÜíC++‚ÜíASM‚ÜíExe + ProofLedger)"

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: swift-no-llvm-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      # ------------------------------------------------------------
      # 0) Checkout
      # ------------------------------------------------------------
      - name: Checkout
        uses: actions/checkout@v4

      # ------------------------------------------------------------
      # 1) Install Tools
      # ------------------------------------------------------------
      - name: Install Tools (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update -y
          sudo apt-get install -y clang g++ nasm zip

      - name: Install Tools (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install llvm nasm || true
          echo 'PATH="/usr/local/opt/llvm/bin:/opt/homebrew/opt/llvm/bin:$PATH"' >> ~/.bash_profile
          source ~/.bash_profile || true

      - name: Install Tools (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          choco install llvm -y
          "C:\Program Files\LLVM\bin" | Out-File -FilePath $env:GITHUB_PATH -Append
          Write-Host "Windows LLVM ready."

      # ------------------------------------------------------------
      # 2) Build Transpiler (C++)
      # ------------------------------------------------------------
      - name: Build Transpiler
        shell: bash
        run: |
          mkdir -p build dist
          echo "Building transpiler from all cpp sources..."

          if [ "$RUNNER_OS" = "Windows" ]; then
            clang++ -std=c++17 \
              src/main.cpp \
              src/parser.cpp \
              src/ast.cpp \
              src/codegen.cpp \
              src/evaluator.cpp \
              -o build/swift_transpiler.exe
          else
            clang++ -std=c++17 \
              src/main.cpp \
              src/parser.cpp \
              src/ast.cpp \
              src/codegen.cpp \
              src/evaluator.cpp \
              -o build/swift_transpiler
          fi

      # ------------------------------------------------------------
      # 3) Swift ‚Üí C++ (Generate out.cpp)
      # ------------------------------------------------------------
      - name: Run Swift ‚Üí C++ Transpiler
        shell: bash
        run: |
          echo "Running transpiler..."
          if [ "$RUNNER_OS" = "Windows" ]; then
            ./build/swift_transpiler.exe || true
          else
            ./build/swift_transpiler || true
          fi

          if [ ! -f out.cpp ]; then
            echo "‚ùå out.cpp missing. Parser failure."
            exit 1
          fi

      # ------------------------------------------------------------
      # 4) Patch out.cpp if needed
      # ------------------------------------------------------------
      - name: Patch C++ Output
        shell: bash
        run: |
          if ! grep -q "int main" out.cpp; then
            echo "‚öôÔ∏è Adding main wrapper"
            sed -i '1i #include <iostream>\nusing namespace std;\nint main(){' out.cpp || true
            echo "}" >> out.cpp
          fi

      # ------------------------------------------------------------
      # 5) Generate ASM
      # ------------------------------------------------------------
      - name: Generate ASM
        shell: bash
        run: |
          echo "Building ASM..."
          clang++ -S -masm=intel out.cpp -o out.asm || true

      # ------------------------------------------------------------
      # 6) Build Executable
      # ------------------------------------------------------------
      - name: Build Executable
        shell: bash
        run: |
          mkdir -p dist
          echo "Building executable from out.cpp..."

          if [ "$RUNNER_OS" = "Windows" ]; then
            clang++ out.cpp -o dist/out.exe
          else
            clang++ out.cpp -o dist/out
          fi

      # ------------------------------------------------------------
      # 7) ProofLedger
      # ------------------------------------------------------------
      - name: Generate ProofLedger
        shell: bash
        run: |
          echo "üßæ Generating ProofLedger..."
          mkdir -p dist

          if command -v sha256sum >/dev/null 2>&1; then
            HASH="sha256sum"
          else
            HASH="shasum -a 256"
          fi

          $HASH out.cpp > dist/PROOF_LEDGER.txt
          $HASH out.asm >> dist/PROOF_LEDGER.txt
          $HASH dist/out* >> dist/PROOF_LEDGER.txt || true

      # ------------------------------------------------------------
      # 8) Package Artifacts
      # ------------------------------------------------------------
      - name: Package Build Artifacts
        shell: bash
        run: |
          if [ "$RUNNER_OS" = "Windows" ]; then
            powershell -command "Compress-Archive -Path dist -DestinationPath swift-no-llvm-windows.zip"
          else
            zip -r swift-no-llvm-${{ matrix.os }}.zip dist
          fi

      # ------------------------------------------------------------
      # 9) Auto Tag
      # ------------------------------------------------------------
      - name: Create Tag
        id: tag
        shell: bash
        run: |
          VERSION="v$(date +%Y%m%d%H%M%S)"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git tag -a "$VERSION" -m "Swift-no-LLVM Release $VERSION"
          git push origin "$VERSION"

      # ------------------------------------------------------------
      # üîü Release
      # ------------------------------------------------------------
      - name: Publish Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.version }}
          files: |
            *.zip
            dist/out*
            dist/*.txt
          body: |
            Swift-with-no-LLVM v22.1
            - Swift ‚Üí C++ Transpiler
            - C++ ‚Üí ASM
            - Native Executable Build
            - ProofLedger SHA256
            - 3OS Ultra-Stable Build Ready

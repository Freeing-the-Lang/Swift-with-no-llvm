name: "Swift-with-no-llvm ‚Äî v21 (C++ Re-Interpreter Build & ASM Generator)"

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: swift-reinterpreter-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build-cpp-reinterpreter:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      # ---------- 0Ô∏è‚É£ Checkout ----------
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ---------- 1Ô∏è‚É£ Build Environment ----------
      - name: Setup C++ Build Environment
        run: |
          sudo apt-get update -y || true
          sudo apt-get install -y g++ nasm python3 make || true
          echo "‚úÖ C++ & NASM installed."

      # ---------- 2Ô∏è‚É£ Compile Swift Re-Interpreter ----------
      - name: Build C++ Swift Re-Interpreter
        run: |
          mkdir -p build dist
          echo "‚öôÔ∏è Compiling Swift Re-Interpreter..."
          g++ -std=c++17 src/main.cpp -o build/swift_reinterpreter
          echo "‚úÖ Re-Interpreter compiled successfully."

      # ---------- 3Ô∏è‚É£ Run Translation: Swift ‚Üí C++ ‚Üí ASM ----------
      - name: Run Re-Interpreter
        run: |
          echo "üß© Translating Swift ‚Üí C++ ‚Üí ASM..."
          ./build/swift_reinterpreter
          echo "‚úÖ Translation completed."
          ls -l out.cpp out.asm || ls -l dist/

      # ---------- 4Ô∏è‚É£ ProofLedger ----------
      - name: Generate ProofLedger
        run: |
          echo "üßæ Generating ProofLedger..."
          mkdir -p dist
          sha256sum out.cpp > dist/PROOF_LEDGER.txt || shasum -a 256 out.cpp > dist/PROOF_LEDGER.txt
          sha256sum out.asm >> dist/PROOF_LEDGER.txt || shasum -a 256 out.asm >> dist/PROOF_LEDGER.txt
          echo "‚úÖ ProofLedger created:"
          cat dist/PROOF_LEDGER.txt

      # ---------- 5Ô∏è‚É£ Package Artifacts ----------
      - name: Package Results
        run: |
          echo "üì¶ Packaging results..."
          mkdir -p dist
          mv out.cpp dist/ || true
          mv out.asm dist/ || true
          zip -r swift-reinterpreter-${{ matrix.os }}.zip dist
          echo "‚úÖ Packaging complete."

      # ---------- 6Ô∏è‚É£ Create Auto Tag ----------
      - name: Create Auto Tag
        id: tag
        shell: bash
        run: |
          VERSION="v$(date +%Y%m%d%H%M%S)"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git tag -a "$VERSION" -m "Swift Re-Interpreter auto release $VERSION"
          git push origin "$VERSION"
          echo "üîñ Created tag $VERSION"

      # ---------- 7Ô∏è‚É£ Publish GitHub Release ----------
      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.version }}
          name: "Swift-with-no-llvm ‚Äî C++ Re-Interpreter ${{ steps.tag.outputs.version }}"
          files: |
            dist/**/*.zip
            dist/**/*.txt
          body: |
            ‚úÖ Auto-built Swift ‚Üí C++ ‚Üí ASM Re-Interpreter release
            - OS: ${{ matrix.os }}
            - Tag: ${{ steps.tag.outputs.version }}
            - ProofLedger SHA256 verified
            - Full C++ re-interpreter build (no LLVM)

name: "Swift-with-no-llvm ‚Äî Executable Build + C++/ASM + ProofLedger"

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: swift-reinterpreter-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      # ---------- 0Ô∏è‚É£ Checkout ----------
      - name: Checkout Repository
        uses: actions/checkout@v4

      # ---------- 1Ô∏è‚É£ Install Build Tools ----------
      - name: Install build tools (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          sudo apt-get update -y || true
          sudo apt-get install -y g++ clang nasm zip || true
          echo "Build tools installed."

      - name: Install build tools (Windows)
        if: runner.os == 'Windows'
        run: |
          choco install llvm -y
          choco install nasm -y
          choco install zip -y
          echo "Build tools installed on Windows."

      # ---------- 2Ô∏è‚É£ Build the Re-Interpreter ----------
      - name: Compile Swift Re-Interpreter (C++)
        run: |
          mkdir -p build dist
          if [ "${{ runner.os }}" = "Windows" ]; then
            clang++ -std=c++17 src/main.cpp -o build/swift_reinterpreter.exe
          else
            clang++ -std=c++17 src/main.cpp -o build/swift_reinterpreter
          fi
          echo "Re-interpreter compiled."

      # ---------- 3Ô∏è‚É£ Run Translation ----------
      - name: Run Swift ‚Üí C++ translation
        run: |
          echo "Translating Swift ‚Üí C++..."
          if [ "${{ runner.os }}" = "Windows" ]; then
            ./build/swift_reinterpreter.exe || true
          else
            ./build/swift_reinterpreter || true
          fi
          echo "Generated files:"
          ls -R .

      # ---------- 4Ô∏è‚É£ Auto-fix out.cpp if needed ----------
      - name: Fix malformed C++ (Auto-main patch)
        run: |
          if [ -f out.cpp ]; then
            if ! grep -q "int main" out.cpp; then
              echo "Applying main-wrapper patch..."
              sed -i '1i #include <iostream>\nusing namespace std;\nint main(){' out.cpp || true
              echo "}" >> out.cpp
            fi
          fi
          echo "C++ file:"
          head -n 20 out.cpp || true

      # ---------- 5Ô∏è‚É£ Create ASM ----------
      - name: Build ASM from C++
        run: |
          if [ -f out.cpp ]; then
            echo "Building ASM..."
            clang++ -S -masm=intel out.cpp -o out.asm || true
          fi

      # ---------- 6Ô∏è‚É£ Create Executable ----------
      - name: Build Executable (binary)
        run: |
          mkdir -p dist
          echo "Building executable..."

          if [ -f out.cpp ]; then
            if [ "${{ runner.os }}" = "Windows" ]; then
              clang++ out.cpp -o dist/out.exe || g++ out.cpp -o dist/out.exe
            else
              clang++ out.cpp -o dist/out || g++ out.cpp -o dist/out
            fi
          fi

          echo "Executable created:"
          ls dist || true

      # ---------- 7Ô∏è‚É£ ProofLedger ----------
      - name: Generate ProofLedger
        run: |
          echo "üßæ Generating ProofLedger..."
          mkdir -p dist

          HASH_CMD=""
          if command -v sha256sum >/dev/null 2>&1; then
            HASH_CMD="sha256sum"
          else
            HASH_CMD="shasum -a 256"
          fi

          $HASH_CMD out.cpp > dist/PROOF_LEDGER.txt || true
          $HASH_CMD out.asm >> dist/PROOF_LEDGER.txt || true
          $HASH_CMD dist/out* >> dist/PROOF_LEDGER.txt || true

          echo "Ledger:"
          cat dist/PROOF_LEDGER.txt

      # ---------- 8Ô∏è‚É£ Package ----------
      - name: Package Build Results
        run: |
          zip -r swift-reinterpreter-${{ runner.os }}.zip dist
          echo "Packaged."

      # ---------- 9Ô∏è‚É£ Tag ----------
      - name: Create Auto Tag
        id: tag
        run: |
          VERSION="v$(date +%Y%m%d%H%M%S)"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git tag -a "$VERSION" -m "Auto Release $VERSION"
          git push origin "$VERSION"

      # ---------- üîü Release ----------
      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.version }}
          files: |
            swift-reinterpreter-*.zip
            dist/**/*.txt
            dist/out*

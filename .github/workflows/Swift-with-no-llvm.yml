name: "Swift-with-no-llvm â€” v23.1 PURE g++ (3OS Stable Pipeline)"

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: swift-no-llvm-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      # -------------------------------------------------------------------
      # 0) Checkout
      # -------------------------------------------------------------------
      - name: Checkout
        uses: actions/checkout@v4

      # -------------------------------------------------------------------
      # 1) Install Tools (No LLVM anywhere, No Chocolatey)
      # -------------------------------------------------------------------
      - name: Install Tools (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update -y
          sudo apt-get install -y g++ clang nasm zip

      - name: Install Tools (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install nasm || true
          echo "Using native macOS clang++/g++"

      - name: Install Tools (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Write-Host "Using built-in Windows compiler and ZIP support."
          clang++ --version

      # -------------------------------------------------------------------
      # 2) Build Transpiler
      # -------------------------------------------------------------------
      - name: Build Transpiler (C++)
        shell: bash
        run: |
          mkdir -p build dist
          echo "Compiling Swift Transpiler (PURE g++)"

          if [ "$RUNNER_OS" = "Windows" ]; then
            clang++ -std=c++17 \
              src/main.cpp src/parser.cpp src/ast.cpp \
              src/codegen.cpp src/evaluator.cpp \
              -o build/swift_transpiler.exe
          else
            g++ -std=c++17 \
              src/main.cpp src/parser.cpp src/ast.cpp \
              src/codegen.cpp src/evaluator.cpp \
              -o build/swift_transpiler || \
            clang++ -std=c++17 \
              src/main.cpp src/parser.cpp src/ast.cpp \
              src/codegen.cpp src/evaluator.cpp \
              -o build/swift_transpiler
          fi

      # -------------------------------------------------------------------
      # 3) Swift â†’ C++ (Generate out.cpp)
      # -------------------------------------------------------------------
      - name: Run Swift â†’ C++ Transpiler
        shell: bash
        run: |
          echo "Running transpiler..."
          if [ "$RUNNER_OS" = "Windows" ]; then
            ./build/swift_transpiler.exe
          else
            ./build/swift_transpiler
          fi

      # -------------------------------------------------------------------
      # 4) Patch out.cpp
      # -------------------------------------------------------------------
      - name: Patch C++ Output
        shell: bash
        run: |
          echo "Patching C++ output..."
          if ! grep -q "int main" out.cpp; then
            sed -i '1i #include <iostream>\nusing namespace std;\nint main(){' out.cpp || true
            echo "}" >> out.cpp
          fi

      # -------------------------------------------------------------------
      # 5) Generate ASM
      # -------------------------------------------------------------------
      - name: Generate ASM (PURE g++)
        shell: bash
        run: |
          echo "Generating ASM..."
          g++ -S -masm=intel out.cpp -o out.asm || \
          clang++ -S -masm=intel out.cpp -o out.asm

      # -------------------------------------------------------------------
      # 6) Build Executable
      # -------------------------------------------------------------------
      - name: Build Executable
        shell: bash
        run: |
          mkdir -p dist
          if [ "$RUNNER_OS" = "Windows" ]; then
            clang++ out.cpp -o dist/out.exe
          else
            g++ out.cpp -o dist/out || clang++ out.cpp -o dist/out
          fi

      # -------------------------------------------------------------------
      # 7) ProofLedger
      # -------------------------------------------------------------------
      - name: Generate ProofLedger
        shell: bash
        run: |
          mkdir -p dist
          echo "ðŸ§¾ Generating ProofLedger..."
          (sha256sum out.cpp || shasum -a 256 out.cpp) > dist/PROOF_LEDGER.txt
          (sha256sum out.asm || shasum -a 256 out.asm) >> dist/PROOF_LEDGER.txt
          (sha256sum dist/out* || shasum -a 256 dist/out*) >> dist/PROOF_LEDGER.txt 2>/dev/null || true

      # -------------------------------------------------------------------
      # 8) Package Artifacts
      # -------------------------------------------------------------------
      - name: Package Artifacts
        shell: bash
        run: |
          if [ "$RUNNER_OS" = "Windows" ]; then
            powershell -command "Compress-Archive -Path dist -DestinationPath swift-no-llvm-windows.zip"
          else
            zip -r swift-no-llvm-${{ matrix.os }}.zip dist
          fi

      # -------------------------------------------------------------------
      # 9) Auto Tag
      # -------------------------------------------------------------------
      - name: Auto Tag
        id: tag
        shell: bash
        run: |
          VER="v$(date +%Y%m%d%H%M%S)"
          echo "version=$VER" >> $GITHUB_OUTPUT
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git tag -a "$VER" -m "Swift-no-LLVM PURE g++ Release $VER"
          git push origin "$VER"

      # -------------------------------------------------------------------
      # 10) Release
      # -------------------------------------------------------------------
      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.version }}
          files: |
            dist/out*
            dist/*.txt
            *.zip
